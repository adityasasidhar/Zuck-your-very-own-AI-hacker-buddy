"""
ExploitDB and CVE lookup tool.
"""

import json
import logging
import re

import requests
from langchain.tools import tool

logger = logging.getLogger('zuck_agent')


@tool
def cve_lookup(cve_id: str) -> str:
    """
    Look up detailed information about a CVE from the NVD database.
    
    Args:
        cve_id: CVE identifier (e.g., "CVE-2021-44228", "CVE-2023-1234")
        
    Returns:
        CVE details including description, severity, and affected products
        
    Examples:
        cve_lookup("CVE-2021-44228")  # Log4Shell
        cve_lookup("CVE-2017-0144")   # EternalBlue
    """
    try:
        cve_id = cve_id.upper().strip()
        
        # Validate CVE format
        if not re.match(r'^CVE-\d{4}-\d{4,}$', cve_id):
            return f"Invalid CVE format: {cve_id}. Expected format: CVE-YYYY-NNNNN"
        
        # Query NVD API
        response = requests.get(
            f"https://services.nvd.nist.gov/rest/json/cves/2.0",
            params={"cveId": cve_id},
            timeout=15
        )
        
        response.raise_for_status()
        data = response.json()
        
        vulnerabilities = data.get("vulnerabilities", [])
        if not vulnerabilities:
            return f"CVE not found: {cve_id}"
        
        cve_data = vulnerabilities[0].get("cve", {})
        
        # Extract description
        descriptions = cve_data.get("descriptions", [])
        description = next(
            (d.get("value") for d in descriptions if d.get("lang") == "en"),
            "No description available"
        )
        
        # Extract CVSS scores
        metrics = cve_data.get("metrics", {})
        cvss_v3 = metrics.get("cvssMetricV31", [{}])[0] if "cvssMetricV31" in metrics else {}
        cvss_v2 = metrics.get("cvssMetricV2", [{}])[0] if "cvssMetricV2" in metrics else {}
        
        cvss_data = cvss_v3.get("cvssData", {}) if cvss_v3 else cvss_v2.get("cvssData", {})
        
        # Extract references
        references = [
            {"url": ref.get("url"), "source": ref.get("source")}
            for ref in cve_data.get("references", [])[:5]
        ]
        
        # Extract weaknesses (CWE)
        weaknesses = []
        for weakness in cve_data.get("weaknesses", []):
            for desc in weakness.get("description", []):
                if desc.get("lang") == "en":
                    weaknesses.append(desc.get("value"))
        
        result = {
            "cve_id": cve_id,
            "description": description[:500],
            "published": cve_data.get("published", "Unknown"),
            "last_modified": cve_data.get("lastModified", "Unknown"),
            "cvss": {
                "version": cvss_data.get("version", "N/A"),
                "base_score": cvss_data.get("baseScore", "N/A"),
                "severity": cvss_data.get("baseSeverity", "N/A"),
                "vector": cvss_data.get("vectorString", "N/A")
            },
            "weaknesses": weaknesses,
            "references": references
        }
        
        return json.dumps(result, indent=2)
        
    except requests.exceptions.RequestException as e:
        logger.error(f"CVE lookup error: {e}")
        return f"Error querying NVD: {str(e)}"
    except Exception as e:
        logger.error(f"CVE lookup error: {e}")
        return f"Error: {str(e)}"


@tool
def search_exploits(query: str, limit: int | str = 10) -> str:
    """
    Search for exploits in ExploitDB using their API.
    
    Args:
        query: Search query (software name, CVE, etc.)
        limit: Maximum results to return (default: 10)
        
    Returns:
        List of matching exploits from ExploitDB
        
    Examples:
        search_exploits("apache 2.4")
        search_exploits("CVE-2021-44228")
        search_exploits("wordpress 5.0")
    """
    try:
        # ExploitDB search via their JSON API
        response = requests.get(
            "https://www.exploit-db.com/search",
            params={
                "q": query,
                "draw": 1,
                "columns[0][data]": "date_published",
                "order[0][column]": 0,
                "order[0][dir]": "desc",
                "start": 0,
                "length": min(int(limit), 50)
            },
            headers={
                "X-Requested-With": "XMLHttpRequest",
                "Accept": "application/json"
            },
            timeout=15
        )
        
        if response.status_code != 200:
            # Fallback: Try the CVE Details API if it's a CVE query
            if query.upper().startswith("CVE-"):
                return _search_cve_details(query)
            return f"ExploitDB request failed with status {response.status_code}"
        
        data = response.json()
        
        results = {
            "query": query,
            "total_found": data.get("recordsTotal", 0),
            "exploits": []
        }
        
        for exploit in data.get("data", [])[:limit]:
            results["exploits"].append({
                "id": exploit.get("id"),
                "title": exploit.get("description", [{}])[0] if isinstance(exploit.get("description"), list) else exploit.get("description", "N/A"),
                "date": exploit.get("date_published"),
                "type": exploit.get("type", {}).get("name", "N/A") if isinstance(exploit.get("type"), dict) else "N/A",
                "platform": exploit.get("platform", {}).get("platform", "N/A") if isinstance(exploit.get("platform"), dict) else "N/A",
                "verified": exploit.get("verified"),
                "url": f"https://www.exploit-db.com/exploits/{exploit.get('id')}"
            })
        
        return json.dumps(results, indent=2)
        
    except requests.exceptions.RequestException as e:
        logger.error(f"ExploitDB search error: {e}")
        return f"Error: {str(e)}"
    except Exception as e:
        logger.error(f"ExploitDB search error: {e}")
        return f"Error: {str(e)}"


def _search_cve_details(cve_id: str) -> str:
    """Fallback CVE search."""
    try:
        return cve_lookup.invoke({"cve_id": cve_id})
    except:
        return f"Could not find exploits for: {cve_id}"


@tool
def exploit_info(exploit_id: str) -> str:
    """
    Get detailed information about a specific ExploitDB exploit.
    
    Args:
        exploit_id: ExploitDB exploit ID (e.g., "50383")
        
    Returns:
        Detailed exploit information
        
    Examples:
        exploit_info("50383")
    """
    try:
        response = requests.get(
            f"https://www.exploit-db.com/exploits/{exploit_id}",
            headers={
                "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0"
            },
            timeout=15
        )
        
        if response.status_code == 404:
            return f"Exploit not found: {exploit_id}"
        
        # Parse basic info from the page
        result = {
            "exploit_id": exploit_id,
            "url": f"https://www.exploit-db.com/exploits/{exploit_id}",
            "raw_url": f"https://www.exploit-db.com/raw/{exploit_id}",
            "download_url": f"https://www.exploit-db.com/download/{exploit_id}",
            "note": "Visit the URL for full exploit code and details"
        }
        
        return json.dumps(result, indent=2)
        
    except Exception as e:
        logger.error(f"Exploit info error: {e}")
        return f"Error: {str(e)}"
