"""
Web penetration testing playbook.
"""

import json
from langchain.tools import tool


@tool
def run_web_pentest(url: str, scope: str = "passive") -> str:
    """
    Run web application penetration testing playbook.
    
    Performs: technology fingerprinting, header analysis, vulnerability checks.
    
    Args:
        url: Target URL
        scope: Test scope - passive (no attacks), active (includes fuzzing)
        
    Returns:
        Web pentest findings
        
    Examples:
        run_web_pentest("https://example.com")
        run_web_pentest("https://target.com", "active")
    """
    from zuck.tools.ssl_analyzer import analyze_security_headers
    from zuck.tools.http import http_request
    from zuck.tools.sql_injection import sqli_payloads
    
    results = {"url": url, "scope": scope, "phases": {}}
    
    # Phase 1: HTTP request and header analysis
    print(f"\nðŸ“‹ Phase 1: HTTP Analysis for {url}")
    try:
        results["phases"]["http"] = json.loads(http_request.invoke({"url": url}))
    except:
        results["phases"]["http"] = "Error"
    
    # Phase 2: Security headers
    print(f"ðŸ“‹ Phase 2: Security Headers")
    try:
        results["phases"]["headers"] = json.loads(analyze_security_headers.invoke({"url": url}))
    except:
        results["phases"]["headers"] = "Error"
    
    # Phase 3: Technology detection (from headers)
    print(f"ðŸ“‹ Phase 3: Technology Detection")
    http_result = results["phases"].get("http", {})
    if isinstance(http_result, dict):
        headers = http_result.get("headers", {})
        results["phases"]["technologies"] = {
            "server": headers.get("Server", "Unknown"),
            "x_powered_by": headers.get("X-Powered-By", "Unknown"),
            "content_type": headers.get("Content-Type", "Unknown")
        }
    
    # Phase 4: Recommendations
    results["recommendations"] = [
        "Run nikto for comprehensive web scan: nikto -h " + url,
        "Test for SQLi with sqlmap: sqlmap -u " + url + " --forms",
        "Check for XSS: Look for reflected input in page source",
        "Test authentication: Check for default credentials"
    ]
    
    if scope == "active":
        results["recommendations"].append("Run directory brute: gobuster dir -u " + url + " -w /usr/share/wordlists/dirb/common.txt")
    
    return json.dumps(results, indent=2)
